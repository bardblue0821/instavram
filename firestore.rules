rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isUser(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    // users/{uid}
    match /users/{uid} {
      allow read: if true;
      allow create: if isUser(uid);
      allow update, delete: if isUser(uid);
    }

    // albums/{albumId}
    match /albums/{albumId} {
      allow read: if true;
      allow create: if isSignedIn()
        && request.resource.data.ownerId == request.auth.uid;
      allow update: if isSignedIn()
        && resource.data.ownerId == request.auth.uid
        && request.resource.data.ownerId == resource.data.ownerId
        && request.resource.data.createdAt == resource.data.createdAt;
      allow delete: if isSignedIn() && resource.data.ownerId == request.auth.uid;
    }

    // albumImages/{imageId}
    match /albumImages/{imageId} {
      allow read: if true;
      allow create: if isSignedIn()
        && request.resource.data.keys().hasAll(['albumId','uploaderId','url'])
        && request.resource.data.uploaderId == request.auth.uid;
      allow delete: if isSignedIn()
        && (
          resource.data.uploaderId == request.auth.uid ||
          get(/databases/$(database)/documents/albums/$(resource.data.albumId)).data.ownerId == request.auth.uid
        );
      allow update: if isSignedIn()
        && resource.data.uploaderId == request.auth.uid
        && request.resource.data.keys().hasAll(['albumId','uploaderId','url','id'])
        && request.resource.data.keys().hasOnly(['albumId','uploaderId','url','id','createdAt'])
        && request.resource.data.albumId == resource.data.albumId
        && request.resource.data.uploaderId == resource.data.uploaderId
        && request.resource.data.url == resource.data.url;
    }

    // comments/{commentId}
    match /comments/{commentId} {
      allow read: if true;
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.body is string
        && request.resource.data.body.size() <= 200
        && request.resource.data.keys().hasAll(['albumId','userId','body','createdAt']);
      allow update: if isSignedIn()
        && resource.data.userId == request.auth.uid
        && request.resource.data.keys().hasOnly(['albumId','userId','body','createdAt','id']);
      allow delete: if isSignedIn()
        && (
          resource.data.userId == request.auth.uid ||
          get(/databases/$(database)/documents/albums/$(resource.data.albumId)).data.ownerId == request.auth.uid
        );
    }

    // likes/{likeId} （ID = albumId_userId）
    match /likes/{likeId} {
      allow read: if true;
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && likeId == request.resource.data.albumId + '_' + request.resource.data.userId
        && request.resource.data.keys().hasAll(['albumId','userId','createdAt']);
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow update: if false;
    }

    // friends/{relationId} （ID = userId_targetId）
    match /friends/{relationId} {
      // 読み取りはログインユーザーなら許可（プロフィール閲覧や申請状態確認を簡易化）
      allow read: if isSignedIn();
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && relationId == request.resource.data.userId + '_' + request.resource.data.targetId
        && request.resource.data.status == 'pending'
        && request.resource.data.keys().hasAll(['id','userId','targetId','status','createdAt']);
      allow update: if isSignedIn()
        && resource.data.targetId == request.auth.uid
        && resource.data.status == 'pending'
        && request.resource.data.status == 'accepted';
      allow delete: if isSignedIn() && (resource.data.userId == request.auth.uid || resource.data.targetId == request.auth.uid);
    }

    // watches/{watchId} （ID = userId_ownerId）
    match /watches/{watchId} {
      // 読み取りはログインユーザーなら許可（プロフィール閲覧やウォッチ状態確認を簡易化）
      allow read: if isSignedIn();
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && watchId == request.resource.data.userId + '_' + request.resource.data.ownerId
        && request.resource.data.keys().hasAll(['id','userId','ownerId','createdAt']);
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow update: if false;
    }

    // notifications/{nid}
    // 本人のみ閲覧・作成・既読化（readAt 追加）。書込は userId == auth.uid に限定。
    match /notifications/{nid} {
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      // 作成は「行為者が自分であること（actorId == auth.uid）」を条件に許可し、
      // 受信者 userId は他者でも可（通知先）。初期作成時は readAt は null 固定。
      allow create: if isSignedIn()
        && request.resource.data.actorId == request.auth.uid
        && request.resource.data.keys().hasAll(['userId','actorId','type','message','createdAt','readAt'])
        && request.resource.data.readAt == null
        && request.resource.data.type in ['comment','like','image','friend_request','watch','repost'];
      allow update: if isSignedIn()
        && resource.data.userId == request.auth.uid
        // 既読化のみ許可: readAt を null→Timestamp に変更し他フィールド不変
        && request.resource.data.keys().hasOnly(['userId','actorId','type','message','createdAt','readAt','albumId','imageId','commentId','friendRequestId','watchId','id'])
        && request.resource.data.userId == resource.data.userId
        && request.resource.data.actorId == resource.data.actorId
        && request.resource.data.type == resource.data.type
        && request.resource.data.message == resource.data.message
        && request.resource.data.createdAt == resource.data.createdAt
        && resource.data.readAt == null
        && request.resource.data.readAt != null; // null 以外（既読化）
      allow delete: if false; // 履歴保持（必要なら本人のみ許可へ変更可）
    }

    // その他のパスは閉じる
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
